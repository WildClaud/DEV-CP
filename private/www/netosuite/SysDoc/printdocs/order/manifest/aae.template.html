<font style="font-size:22px; font-weight:bold;">Print Manifest Report - AAE</font>
<br><br>
<table cellpadding="2px" cellspacing="0" border="0">
<tr><td><b>Manifest Created Date:</b></td>
	<td>[? print format_date({date=> $_DATA{date_manifest}, format=>'#W, #d #k, #Y'}) ?]</td></tr>
<tr><td><b>Date Printed:</b></td>
	<td>[? print format_date({date=> 'now', format=>'#W, #d #k, #Y'}) ?]</td></tr>
<tr><td><b>Manifest Number:</b></td>
	<td>[? print $_DATA{manifest_id} ?]</td></tr>
<tr><td><b>Australia Air Express Account Number:</b></td>
	<td>[? print $_DATA{merchant_acc} ?]</td></tr>
<tr><td><b>Customer Account ID:</b></td>
	<td>[? print $_DATA{merchant_id} ?]</td></tr>
</table>
<br>
<table width="100%" cellpadding="2px" cellspacing="0" border="0">
	<tr><td class="hdr">Cnsgmt Nbr</td>
  	<td class="hdr">Article Nbr</td>
    <td class="hdr">DeliverTo</td>
    <td class="hdr">Postcode</td>
    <td class="hdr">Country</td>
    <td class="hdr">Charge Code Description</td>
    <td class="hdr">Charging Zone</td>
    <td class="hdr">Dngrous Goods</td>
    <td class="hdr">Total Articles in Consgmt</td>
    <td class="hdr">Extra/ Transit Cover</td>
    <td class="hdr">Cubic Weight</td>
    <td class="hdr">Actual Weight</td>
    <td class="hdr">Chargeable Weight</td></tr>
<!--##[?
$stotal_con =
$stotal_art =
$stotal_cubic =
$stotal_shipping =
$stotal_charge =
$total_con =
$total_art =
$total_cubic =
$total_shipping =
$total_charge = 0;

our %SERVICES;
my( $sql, $sth, $serv );
my $db_mid = db_quote($_DATA{manifest_id});

	#
	# BUILD a table for the service codes breakdown
	#
	$sql = "select S.* from SH_MANIFESTS M,SH_SERVICES S WHERE M.manifest_id = $db_mid and S.shacc_id = M.shacc_id";
	$sth = run_sql_dyn($sql);
	while($serv = $sth->fetchrow_hashref) {
		$SERVICES{$serv->{shserv_code}} = [0,0];
	}
	
 $sql = "SELECT DISTINCT I.zone_id, I.zone_code FROM SH_CONSIGNMENTS C INNER JOIN ZONES_INFO I USING (zone_id) ".
	"WHERE manifest_id=$db_mid ORDER BY I.zone_code";
 $sth = run_sql_dyn($sql);
while($zr = $sth->fetchrow_hashref) {
	my $db_zid = db_quote($zr->{zone_id});
	
	my $sql2 = "SELECT C.*, O.ship_first_name, O.ship_last_name, O.ship_company, ".
		"O.ship_street1, O.ship_street2, O.ship_city, O.ship_zip, O.ship_country, S.shserv_code, S.shserv_name ".
		"FROM SH_CONSIGNMENTS C INNER JOIN ORDERS O USING (order_id) LEFT JOIN SH_SERVICES S USING (shserv_id) ".
		"WHERE manifest_id=$db_mid AND zone_id=$db_zid ORDER BY cngmt_id";
	my $sth2 = run_sql_dyn($sql2);
	while($cng = $sth2->fetchrow_hashref) {

		my $db_cid = db_quote($cng->{cngmt_id});
		$SERVICES{$cng->{shserv_code}}[0]++; 

		my $art_count = 0;
		my $sql3 = "SELECT * FROM SH_ARTICLES WHERE cngmt_id=$db_cid ORDER BY art_id";
		my $sth3 = run_sql_dyn($sql3);
		my $art_total = $sth3->rows;
		while($row = $sth3->fetchrow_hashref) {
			my %TMP = (%{$zr}, %{$cng}, %{$row});
			$TMP{cubic} = sprintf("%.02f", $TMP{cubic} * $TMP{cubic_modifier});
			$TMP{shipping} = sprintf("%.02f", $TMP{shipping});
			if($TMP{shipping} <=0) { $TMP{shipping}=0.01; }
			$TMP{charge} = ($TMP{cubic}>$TMP{shipping}? $TMP{cubic}: $TMP{shipping});
			$SERVICES{$cng->{shserv_code}}[1] += $TMP{shipping};
			if($art_count==0) {
				$TMP{ship_country_name} = country_name($TMP{ship_country});
				$TMP{name} = ($TMP{ship_first_name} eq '' ? $TMP{ship_company} : $TMP{ship_first_name}.' '.$TMP{ship_last_name});
				my $tran_txt = ($TMP{transit_cover}>0? 'Y' : 'N');
				my $danger_txt = ($TMP{danger} eq 'y'? 'Y' : 'N');
				print qq~##-->
<tr><td class="itm">$TMP{cngmt_number}</td>
  <td class="itm">$TMP{article_number}</td>
  <td class="itm">$TMP{name}<br>$TMP{ship_street1}<br>$TMP{ship_street2}<br>$TMP{ship_city}</td>
  <td class="itm">$TMP{ship_zip}</td>
  <td class="itm">$TMP{ship_country_name}</td>
  <td class="itm">$TMP{shserv_name}</td>
  <td class="itm">$TMP{zone_code}</td>
  <td class="itm" align="center">$danger_txt</td>
  <td class="itm" align="right">$art_total</td>
  <td class="itm" align="center">$tran_txt</td>
  <td class="itm" align="right">$TMP{cubic}</td>
  <td class="itm" align="right">$TMP{shipping}</td>
  <td class="itm" align="right">$TMP{charge}</td></tr>
<!--##~;
			} else {
				print qq~##-->
<tr><td class="itm">&nbsp;</td>
  <td class="itm">$TMP{article_number}</td>
  <td class="itm">&nbsp;</td>
  <td class="itm">&nbsp;</td>
  <td class="itm">&nbsp;</td>
  <td class="itm">&nbsp;</td>
  <td class="itm">&nbsp;</td>
  <td class="itm" align="center">&nbsp;</td>
  <td class="itm" align="right">&nbsp;</td>
  <td class="itm" align="center">$tran_txt</td>
  <td class="itm" align="right">$TMP{cubic}</td>
  <td class="itm" align="right">$TMP{shipping}</td>
  <td class="itm" align="right">$TMP{charge}</td></tr>
<!--##~;
			}
			$art_count++;
			
			$stotal_art++;
			$stotal_cubic+=$TMP{cubic};
			$stotal_shipping+=$TMP{shipping};
			$stotal_charge+=$TMP{charge};
		}
		$stotal_con++;
	}
	
	my $cng_txt = ($stotal_con==1?'consignment':'consignments');
	$stotal_cubic = sprintf("%.02f", $stotal_cubic);
	$stotal_shipping = sprintf("%.02f", $stotal_shipping);
	$stotal_charge = sprintf("%.02f", $stotal_charge);

	print qq~##-->
<tr><td class="subtotal" colspan="8"><b>Subtotal</b> (for  $stotal_con $cng_txt)</td>
<td class="subtotal" align="right">$stotal_art</td>
<td class="subtotal">&nbsp;</td>
<td class="subtotal" align="right">$stotal_cubic</td>
<td class="subtotal" align="right">$stotal_shipping</td>
<td class="subtotal" align="right">$stotal_charge</td></tr>
<tr><td colspan="13">&nbsp;</td></tr>
<!--##~;

	$total_con +=$stotal_con;
	$total_art +=$stotal_art;
	$total_cubic +=$stotal_cubic;
	$total_shipping +=$stotal_shipping;
	$total_charge += $stotal_charge;

	$stotal_con =
	$stotal_art =
	$stotal_cubic =
	$stotal_shipping =
	$stotal_charge = 0;
}

?]##-->
<tr><td colspan="13" style="border-top: 2px solid #000000;">&nbsp;</td></tr>
<tr><td class="total" colspan="8"><b>Total</b> (for  <!--##[? print $total_con.' '.($total_con==1?'consignment':'consignments') ?]##-->)</td>
<td class="total" align="right">[? printf("%.02f", $total_art) ?]</td>
<td class="total">&nbsp;</td>
<td class="total" align="right">[? printf("%.02f", $total_cubic) ?]</td>
<td class="total" align="right">[? printf("%.02f", $total_shipping) ?]</td>
<td class="total" align="right">[? printf("%.02f", $total_charge) ?]</td></tr>
<tr><td colspan="13" style="border-bottom: 2px solid #000000; ">&nbsp;</td></tr>
</table>
<br><br>
<table width="100%" cellpadding="0" cellspacing="0" border="0">
	<tr>
		<td><b>Consignments:</b></td>
		<td><!--##[? print $total_con; ?] ##--></td>
		<!--##[?
		#
		# print out the service code headings
		#
		for my $srvc (sort { $a cmp $b } keys %SERVICES ) {
			print "<td><b>$srvc</b></td>";
		}
		?]##-->
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td>Consignments:</td>
		<!--##[?
		#
		# print out the number of consignments for each service code
		#
		for my $srvc (sort { $a cmp $b } keys %SERVICES ) {
			print "<td>$SERVICES{$srvc}[0]</td>";
		}
		?]##-->
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td>Weight:</td>
		<!--##[?
		#
		# print out the total weight for each service code
		#
		for my $srvc (sort { $a cmp $b } keys %SERVICES ) {
			print "<td>$SERVICES{$srvc}[1]</td>";
		}
		?]##-->
	</tr>
</table>
<br><br>
<table cellpadding="0" cellspacing="0" width="100%" border="0">
	<tr>
		<td><b>Account:</b></td>
		<td><!--##[? print $_DATA{merchant_acc}; ?]##--></td>
		<td><b>Consignments:</b></td>
		<td><!--##[? print $total_con; ?]##--></td>
		<td><b>Total Weight:</b></td>
		<td><!--##[? printf("%.02f", $total_shipping) ?]##--></td>
	</tr>
</table>
<br><br>
<table cellpadding="0" cellspacing="0" border="0">
	<tr>
		<td colspan="2"><b>Service Provider Totals:</b></td>
	</tr>
	<tr>
		<td colspan="2"><!--##[? print "There ".($total_con == 1 ? "is" : "are") . " $total_con consignment".($total_con == 1 ? "" : "s") . 
			" and $total_art article".($total_art == 1 ? "" : "s") ; ?]##-->
	 	</td>
	</tr>
	<tr>
		<td>TOTAL WEIGHT:</td>
		<td><!--##[? printf("%.02f", $total_shipping) ?]##--></td>
	</tr>
</table>
<br><br>
<table cellpadding="0" cellspacing="0" width="100%" border="0">
	<tr>
		<td width="60%" height="100%" class="aae_manifest_left">
			<table cellpadding="0" cellspacing="0" border="0">
				<tr>
					<td><p class="tiny even"><b>SECURITY STATEMENT:</b><br>
						This consignment does not contain any explosive or incendiary device.
						I understand that this consignment may be subject to security screening, by Explosive
					Trace Detection, X-Ray or physical search.</p><br>
					</td>
				</tr>
				<tr>
					<td><p class="tiny even"><b>DANGEROUS GOODS STATEMENT:</b><br>
						I acknowledge this consignment may travel by air and make this statement for
						the purpose of Section 23A of the Civil Aviation Act.</span> <span id="dg">This consignment 
					does not contain dangerous goods.</p>
						<p class="tiny even">I understand that my signature renders me personally
						responsible for the above statements and that a false or misleading statement 
						made knowingly or recklessly is a statutory offence punishable by impriconment and/or a 
					fine and may render me liable in damages for breach of contract.</p>
					</td>
				</tr>
				<tr>
					<td class="tiny"><br>Signed by Client:</td>
				</tr>
				<tr><td style="border-bottom: 2px solid #000000; ">&nbsp;</td></tr>
				<tr>
					<td class="tiny"><br>Printed name:</td>
				</tr>
				<tr><td style="border-bottom: 2px solid #000000; ">&nbsp;</td></tr>
				<tr><td class="tiny label">SENT VIA INTERNET</td></tr>
			</table>
		</td>
		<td class="aae_manifest_right">
			<table  cellpadding="0" cellspacing="20" border="0" width="100%">
				<tr>
					<td class="tiny" colspan="2">Signed by Driver:</td>
				</tr>
				<tr>
					<td class="driver" colspan="2">&nbsp;</td>
				</tr>
				<tr>
					<td class="tiny" width="30%">Driver ID:</td>
					<td class="driver">&nbsp;</td>
				</tr>
				<tr>
					<td class="tiny" width="20%">Pickup Time:</td>
					<td class="driver">&nbsp;</td>
				</tr>
			</table>
		</td>
	</tr>
</table>

